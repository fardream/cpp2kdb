<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>cpp2kdb: Wrapper details</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">cpp2kdb
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Wrapper details </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="autotoc_md7"></a>
How to use &lt;tt&gt;k.h&lt;/tt&gt; to get data from KDB</h1>
<p>Before diving into the wrapper code, let's start to looking at how to use <code>k.h</code> to connect to KDB and get some data back. KxSystems' documentation is <a href="https://code.kx.com/q/interfaces/c-client-for-q/">here</a>.</p>
<ol type="1">
<li><p class="startli">Connect to kdb by calling one of the functions <code>khp</code>, <code>khpu</code>, <code>khpun</code>, <code>khpunc</code>.</p>
<p class="startli">It looks like the ones with longer names are just setting default parameters for the shorter ones, and we are going to use the one with the longest name</p>
<p class="startli">```C++ char* hostname = "hostname"; char* username_password = "username:password"; int time_out = 0; int capacity = 0; int connection = khpunc(hostname, port_number, username_password, time_out, capacity); ```</p>
</li>
</ol>
<ol type="1">
<li><p class="startli">Run the query by calling function <code>k</code> on the connection.</p>
<p class="startli">```C++ char* query = "1"; K result = k(connection, query, (K)0); ```</p>
<p class="startli">This will get run the query on remote KDB server and return the result as a <code>K</code>.</p>
</li>
</ol>
<ol type="1">
<li>Do something with the result.</li>
</ol>
<ol type="1">
<li>Normally, the reference count on the <code>K</code> object needs to be <b>manually</b> reduced by calling a function <code>r0</code>.</li>
</ol>
<ol type="1">
<li><p class="startli">Close the connection.</p>
<p class="startli">```C++ kclose(connection); ```</p>
</li>
</ol>
<p>One note here: <code>char*</code> is used as string in many places because <code>k.h</code> expects <code>S</code>, which is just <code>char*</code>. However, any recent compiler will give out a warning or error.</p>
<div class="fragment"><div class="line">warning: ISO C++11 does not allow conversion from string literal to &#39;char *&#39; [-Wwritable-strings]</div>
</div><!-- fragment --><p>And <code>const char*</code> (the proper type for string literals) should not be passed as type <code>char*</code> for obvious reasons.</p>
<h1><a class="anchor" id="autotoc_md8"></a>
Result from KDB, &lt;tt&gt;K&lt;/tt&gt; object</h1>
<p>How to get data from this <code>K</code> object? <code>K</code> is actually not a class, it's a pointer type defined on <a href="https://github.com/KxSystems/kdb/blob/39b957030bf6a4608f2508ff29894d7fac32a0c2/c/c/k.h#L11">line 11</a> for <code>KXVER&gt;=3</code>.</p>
<div class="fragment"><div class="line"> {C++}</div>
<div class="line">typedef struct k0{signed char m,a,t;C u;I r;union{G g;H h;I i;J j;E e;F f;S s;struct k0*k;struct{J n;G G0[1];};};}*K;</div>
</div><!-- fragment --><p>Or in proper <code>C++</code> style</p>
<div class="fragment"><div class="line"> {C++}</div>
<div class="line">typedef struct k0 {</div>
<div class="line">  signed char m, a, t;</div>
<div class="line">  C u;</div>
<div class="line">  I r;</div>
<div class="line">  union {</div>
<div class="line">    G g;</div>
<div class="line">    H h;</div>
<div class="line">    I i;</div>
<div class="line">    J j;</div>
<div class="line">    E e;</div>
<div class="line">    F f;</div>
<div class="line">    S s;</div>
<div class="line">    struct k0* k;</div>
<div class="line">    struct {</div>
<div class="line">      J n;</div>
<div class="line">      G G0[1];</div>
<div class="line">    };</div>
<div class="line">  };</div>
<div class="line">} * K;</div>
</div><!-- fragment --><ol type="1">
<li>It can be seen that <code>K</code> is a pointer to <code>struct k0</code> (why not <code>k</code>? remember it's already used by the function <code>k</code>).</li>
</ol>
<ol type="1">
<li>The only data we need is in the union part of the object.<ul>
<li>The pointer type <code>k0* k</code> indicates this <code>K</code> is containing another <code>K</code>, which only happens for table type.</li>
<li>The struct with <code>n</code> and <code>G0</code> in it indicating a vector of sorts, which <code>n</code> indicates the number of elements contained by <code>G0</code>, and <code>G0</code> is a pointer pointing to that memory location. The type <code>G</code> is actually <code>unsigned char</code>, which is not directly convertible to other types (unlike <code>char*</code>);</li>
</ul>
</li>
</ol>
<ol type="1">
<li>The type of the <code>K</code> object is indicated by <code>t</code>. The exact type is listed in <a href="https://code.kx.com/q/interfaces/c-client-for-q/#overview">KxSystems' documentation</a>. The only special case that needs to mention is <code>symbol</code>, which is actually a <code>char*</code> pointing to a null-terminated <code>char</code> array (like a proper <code>C</code> string), where as string in KDB sense is an array of <code>char</code> that is <b>NOT null-terminated</b>.</li>
</ol>
<h1><a class="anchor" id="autotoc_md9"></a>
How to actually access the data from &lt;tt&gt;K&lt;/tt&gt;?</h1>
<ul>
<li>To get an <b>atomic</b> value from <code>K</code>, just use the corresponding accessor.</li>
<li>To get the content of the vector, get the pointer <code>G0</code> and cast it to the type indicated by <code>t</code>. </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1
</small></address>
</body>
</html>
